<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メインコピー生成</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* APIキー入力フィールドの表示・非表示アニメーション */
        .api-key-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .api-key-section.open {
            max-height: 500px; /* 十分な高さを確保 */
        }
    </style>
</head>
<body class="bg-gray-100 py-8 sm:py-12">

    <div class="container mx-auto p-4 md:p-8 max-w-3xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-10">
            
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">AIメインコピー生成</h1>
                <p class="text-gray-500">ウェブページのURLから、AIが魅力的なメインコピーを提案します。</p>
            </header>

            <!-- APIキー設定セクション -->
            <div id="apiKeySection" class="api-key-section mb-6">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
                    <h3 class="text-lg font-bold text-yellow-800">APIキーを設定してください</h3>
                    <p class="text-yellow-700 text-sm mt-1">
                        このアプリを使用するには、Google AIの無料APIキーが必要です。
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="font-bold underline hover:text-yellow-800">こちらのリンク</a>
                        からキーを取得し、以下に貼り付けて保存してください。
                    </p>
                    <div class="flex flex-col sm:flex-row gap-2 mt-4">
                        <input type="password" id="apiKeyInput" placeholder="APIキーをここに貼り付け" class="flex-grow w-full px-4 py-2 bg-white border-2 border-yellow-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <button id="saveApiKeyButton" class="w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">保存</button>
                    </div>
                </div>
            </div>

            <main id="mainContent" class="hidden">
                <!-- URL入力フォーム -->
                <div class="space-y-4 mb-6">
                    <div>
                        <label for="urlInput" class="block text-sm font-medium text-gray-700 mb-1">ウェブサイトURL</label>
                        <input type="url" id="urlInput" placeholder="https://example.com" class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="additionalRequestInput" class="block text-sm font-medium text-gray-700 mb-1">
                            追加の要望 (任意)
                        </label>
                        <textarea id="additionalRequestInput" rows="2" placeholder="例: 若者向け、面白い感じで、SEOを意識して" class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>

                <div class="text-center">
                    <button id="generateButton" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">
                        提案を生成
                    </button>
                </div>

                <!-- 結果表示エリア -->
                <div id="resultContainer" class="mt-8">
                    <div id="loader" class="hidden flex flex-col items-center justify-center text-center p-8">
                        <div class="loader mb-4"></div>
                        <p class="text-gray-600 font-semibold">AIがページを読み込んで分析中です...</p>
                    </div>
                    <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                        <strong class="font-bold">エラーが発生しました。</strong>
                        <span class="block sm:inline" id="errorText"></span>
                    </div>
                    <div id="manualInputContainer" class="hidden mt-6 p-6 bg-gray-50 rounded-lg border border-dashed">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">URLの読み込みに失敗しました</h3>
                        <p class="text-gray-600 mb-4">お手数ですが、サイトのテキストを以下に直接貼り付けてください。</p>
                        <textarea id="manualTextInput" rows="10" class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-lg" placeholder="ここにウェブサイトの本文を貼り付け..."></textarea>
                        <button id="generateFromTextButton" class="mt-4 w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">
                            このテキストから生成
                        </button>
                    </div>
                    <div id="copyResult" class="hidden mt-6">
                         <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 pb-2">提案されたメインコピー</h2>
                         <div id="copyList" class="grid grid-cols-1 gap-4"></div>
                    </div>
                </div>
            </main>
        </div>
        <footer class="text-center mt-6 text-gray-500 text-sm">
            <p>&copy; 2024 コーディング パートナー</p>
        </footer>
    </div>

    <script>
        // DOM要素
        const apiKeySection = document.getElementById('apiKeySection');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyButton = document.getElementById('saveApiKeyButton');
        const mainContent = document.getElementById('mainContent');
        const urlInput = document.getElementById('urlInput');
        const additionalRequestInput = document.getElementById('additionalRequestInput');
        const generateButton = document.getElementById('generateButton');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const copyResult = document.getElementById('copyResult');
        const copyList = document.getElementById('copyList');
        const manualInputContainer = document.getElementById('manualInputContainer');
        const manualTextInput = document.getElementById('manualTextInput');
        const generateFromTextButton = document.getElementById('generateFromTextButton');

        // アプリケーションの初期化
        document.addEventListener('DOMContentLoaded', () => {
            checkApiKey();
            saveApiKeyButton.addEventListener('click', saveApiKey);
            generateButton.addEventListener('click', handleGeneration);
            generateFromTextButton.addEventListener('click', handleGenerationFromText);
        });

        // APIキーの確認とUIの切り替え
        function checkApiKey() {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (apiKey) {
                apiKeySection.classList.remove('open');
                mainContent.classList.remove('hidden');
            } else {
                apiKeySection.classList.add('open');
                mainContent.classList.add('hidden');
            }
        }

        // APIキーをローカルストレージに保存
        function saveApiKey() {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                apiKeyInput.value = '';
                checkApiKey();
            } else {
                alert('APIキーを入力してください。');
            }
        }

        async function callGeminiAPI(textContent, additionalRequest) {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                throw new Error('APIキーが設定されていません。設定画面からキーを保存してください。');
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            let prompt = `以下のウェブサイトのコンテンツを分析し、ユーザーの興味を引く魅力的なメインコピーを日本語で10個提案してください。以下のルールを厳守してください:\n- 箇条書きで、提案するコピーのみをリストアップすること。\n- 説明文や前置き、結びの言葉は一切含めないこと。\n- 「」や他の記号は一切使用しないこと。`;

            if (additionalRequest) {
                prompt = `以下のウェブサイトのコンテンツと【追加の要望】を基に、ユーザーの興味を引く魅力的なメインコピーを日本語で10個提案してください。以下のルールを厳守してください:\n- 箇条書きで、提案するコピーのみをリストアップすること。\n- 説明文や前置き、結びの言葉は一切含めないこと。\n- 「」や他の記号は一切使用しないこと。\n\n【追加の要望】\n${additionalRequest}`;
            }
            prompt += `\n\n---\n[ウェブサイトのコンテンツ]\n${textContent}\n---\n\n提案:`;
            
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                 if(response.status === 400) {
                    throw new Error('APIキーが正しくないか、無効になっている可能性があります。');
                 }
                 throw new Error('AIとの通信に失敗しました。');
            }

            const result = await response.json();
            
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error('AIが有効な提案を生成できませんでした。');
            }
        }
        
        async function handleGeneration() {
            const url = urlInput.value.trim();
            if (!url) { showError('URLを入力してください。'); return; }
            resetUI(); setLoadingState(true);
            try {
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`ページの取得に失敗しました (ステータス: ${response.status})`);
                const htmlContent = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const bodyText = doc.body.innerText || "";
                if (bodyText.trim().length < 50) throw new Error('ページから十分なテキストを抽出できませんでした。');
                await generateCopy(bodyText);
            } catch (error) {
                console.error('URLからの生成エラー:', error);
                const userMessage = 'ページの自動取得に失敗しました。サイトが外部アクセスをブロックしているか、URLが正しくない可能性があります。';
                showError(userMessage);
                manualInputContainer.classList.remove('hidden');
            } finally {
                setLoadingState(false);
            }
        }

        async function handleGenerationFromText() {
            const textContent = manualTextInput.value.trim();
            if (!textContent) { showError('テキストエリアに内容を貼り付けてください。'); return; }
            resetUI(); setLoadingState(true);
            await generateCopy(textContent);
            setLoadingState(false);
        }

        async function generateCopy(textContent) {
             try {
                const truncatedText = textContent.substring(0, 4000);
                const additionalRequest = additionalRequestInput.value.trim();
                const generatedCopyText = await callGeminiAPI(truncatedText, additionalRequest);
                displayResults(generatedCopyText);
             } catch(apiError) {
                console.error('API呼び出しエラー:', apiError);
                showError(apiError.message || 'AIからの応答がありませんでした。');
             }
        }

        function setLoadingState(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
                generateButton.disabled = true;
                generateButton.textContent = '生成中...';
            } else {
                loader.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.textContent = '提案を生成';
            }
        }

        function resetUI() {
            errorMessage.classList.add('hidden');
            copyResult.classList.add('hidden');
            manualInputContainer.classList.add('hidden'); 
            copyList.innerHTML = '';
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function displayResults(text) {
            copyList.innerHTML = '';
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            lines.forEach(line => {
                const cleanText = line.replace(/^[\s*-\d.]+\s*/, '').replace(/「|」/g, '').trim();
                if (cleanText) {
                    const card = document.createElement('div');
                    card.className = 'bg-slate-50 p-4 rounded-lg border border-gray-200 flex flex-col sm:flex-row justify-between sm:items-center gap-4 transition-shadow hover:shadow-md';
                    card.innerHTML = `<p class="text-gray-800 flex-grow text-lg">${cleanText}</p><button class="copy-button flex-shrink-0 w-full sm:w-auto bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2"><span>コピー</span></button>`;
                    card.querySelector('.copy-button').addEventListener('click', (e) => copyToClipboard(cleanText, e.currentTarget));
                    copyList.appendChild(card);
                }
            });
            copyResult.classList.remove('hidden');
        }
        
        function copyToClipboard(text, buttonElement) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = `<span>コピーしました！</span>`;
                buttonElement.classList.replace('bg-gray-200', 'bg-green-500');
                buttonElement.classList.add('text-white');
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.classList.replace('bg-green-500', 'bg-gray-200');
                    buttonElement.classList.remove('text-white');
                }, 2000);
            }).catch(err => {
                console.error('クリップボードへのコピーに失敗しました', err);
            });
        }
    </script>
</body>
</html>
